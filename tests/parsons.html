<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" 
          "http://www.w3.org/TR/html4/loose.dtd">
<html>
  <head>
    <script src="http://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js"></script>
    <script src="http://ajax.googleapis.com/ajax/libs/jqueryui/1.8.18/jquery-ui.min.js"></script>
    <script src="../lib/underscore-min.js"></script>
    <script src="../lib/lis.js"></script>
    <script src="../parsons.js"></script>
    <link rel="stylesheet" href="http://code.jquery.com/qunit/qunit-git.css" type="text/css" media="screen" />
    <script src="http://code.jquery.com/qunit/qunit-git.js"></script>
    
    <script>

var assertCodeEquals = function(lines1, lines2) {
	equal(lines1.length, lines2.length);
}

module("Utilities");

test("getRondomPermutation()", function() {
        var initial = [[0, 'foo'],
                       [1, 'bar']];                                    
        var parson = new ParsonsWidget( {'codeLines': initial,
                                         'sortableId': 'main'});
        var perm = parson.getRandomPermutation(2);
        equal(perm.length,2);
		ok( (perm[0] == 0 && perm[1] == 1) || (perm[0] == 1 && perm[1] == 0) );    
    });

test("normalizeIndents()", function() {
	
		var codeLine = function(elem, index) { return {'indent': elem}; };
        var initial = [[0, 'foo'],
                       [1, 'bar']];                                    
        var parson = new ParsonsWidget( {'codeLines': initial,
                                         'sortableId': 'main'});
        var perm = parson.getRandomPermutation(2);
        deepEqual(
			parson.normalizeIndents(jQuery.map([0, 1, 2, 1], codeLine)),	
			jQuery.map([0, 1, 2, 1], codeLine),
			"already normalized");
		deepEqual(
			parson.normalizeIndents(jQuery.map([1, 4, 5, 4], codeLine)),	
			jQuery.map([0, 1, 2, 1], codeLine),
			"too much indented");
			
		deepEqual(
			parson.normalizeIndents(jQuery.map([1, 4, 5, 3], codeLine)),	
			jQuery.map([0, 1, 2, -1], codeLine),
			"no matching indentation");			
	});	

module("Initialization of t");

test("internal data structures - no extra lines", function() {
        var initial = [[0, 'foo'],
                       [1, 'bar']];                                    
        var parson = new ParsonsWidget( {'codeLines': initial,
                                         'sortableId': 'main'});
        parson.createHtml();
                                                 
        expect(3);
        equal(parson.extra_lines.length, 0);
        equal(parson.model_solution.length, 2);
        equal(parson.modified_lines.length, 2);
    });

test("internal data structures - extra lines", function() {
        var initial = [[0, 'foo'],
                       [1, 'bar'],
					   [-1, 'buz']];                                    
        var parson = new ParsonsWidget( {'codeLines': initial,
                                         'sortableId': 'main'});
        parson.createHtml();
                                                 
        expect(3);
        assertCodeEquals(parson.extra_lines, ['baz']);
        assertCodeEquals(parson.model_solution, ['foo', 'bar']);
        assertCodeEquals(parson.modified_lines, ['foo', 'bar', 'buz']);
    });

	
test("Initialization of internal data structures - two parallel widgets", function() {
        var initial = [[0, 'foo'],
                       [1, 'bar']];
	var initial2 = [[0, 'baz'],
                        [-1, 'should not exist']];
        var parson = new ParsonsWidget( {'codeLines': initial,
                                         'sortableId': 'main'});
        var parson2 = new ParsonsWidget( {'codeLines': initial2,
                                          'sortableId': 'main2'});
        parson.createHtml();      
        parson2.createHtml();
                                                 
        expect(2);
        equal(parson.model_solution.length, 2);
        equal(parson2.model_solution.length, 1);
    });

                                         
module("Feedback without extra lines");

test("Indentation error on second line", function() {
        var initial = [[0, 'foo'],
                       [1, 'bar']];                                    
        var parson = new ParsonsWidget( {'codeLines': initial,
                                         'sortableId': 'main'});
        parson.createHtml();
        expect(2);
        ok(0 == parson.extra_lines.length, "No extra lines were given");
        ok(parson.getFeedback().length > 0);
    });                                 

test("No errors", function() {
        var initial = [[0, 'def traverse_in_order(binary_node):'],
                       [0, 'if binary_node:']];                                    
        var parson = new ParsonsWidget( {'codeLines': initial,
                                         'sortableId': 'main'});
        parson.createHtml();
                                                 
        expect(2);
        ok(0 == parson.extra_lines.length, "No extra lines were given");
        ok(parson.getFeedback().length == 0, "No indentation so all should be fine");
    });
                                 

module("getModifiedCode with or without permutations");                         
var noPermutation = function(n) {return [0, 1];};
var swapPermutation = function(n) {return [1, 0];};

test("First two lines swapped in the beginning", function() {
        var initial = [[0, 'foo'],
                       [0, 'bar']];                                    
        var parson = new ParsonsWidget( {'codeLines': initial,
                                         'sortableId': 'main'});
                                         
        parson.createHtml(swapPermutation);
        var modified = parson.getModifiedCode("#ul-" + 'main');
        expect(2);
        equal(modified[0].code, 'bar');
        equal(modified[1].code, 'foo');
    });

test("First two lines are not swapped", function() {
        var initial = [[0, 'foo'],
                       [0, 'bar']];                                    
        var parson = new ParsonsWidget( {'codeLines': initial,
                                         'sortableId': 'main'});
        parson.createHtml(noPermutation);
        var modified = parson.getModifiedCode("#ul-" + 'main');
        expect(2);
        equal(modified[0].code, 'foo');
        equal(modified[1].code, 'bar');
    });

  
    </script>
  
</head>
<body>
 <div id="main"> </div>
 <div id="main2"> </div>
        
 <h1 id="qunit-header">js-parsons tests</h1>
 <h2 id="qunit-banner"></h2>
 <h2 id="qunit-userAgent"></h2>
 <ol id="qunit-tests"></ol>
</body>
</html>
